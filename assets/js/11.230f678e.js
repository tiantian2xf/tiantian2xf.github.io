(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{227:function(s,t,n){"use strict";n.r(t);var a=n(0),e=Object(a.a)({},(function(){var s=this.$createElement;this._self._c;return this._m(0)}),[function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"日志规范"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#日志规范"}},[s._v("#")]),s._v(" 日志规范")]),s._v(" "),n("h1",{attrs:{id:"_1-nginx日志规范"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-nginx日志规范"}},[s._v("#")]),s._v(" 1.Nginx日志规范")]),s._v(" "),n("h2",{attrs:{id:"ng配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ng配置"}},[s._v("#")]),s._v(" ng配置")]),s._v(" "),n("p",[s._v("一般来说：nginx的log_format有很多可选的参数用于指示服务器的活动状态，默认的是：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('log_format  main  \'$remote_addr - $remote_user [$time_local] "$request" \'\n                  \'$status $body_bytes_sent "$http_referer" \'\n                  \'"$http_user_agent" "$http_x_forwarded_for"\';\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("table",[n("thead",[n("tr",[n("th",[s._v("参数")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("$remote_addr")]),s._v(" "),n("td",[s._v("客户端地址")])]),s._v(" "),n("tr",[n("td",[s._v("$remote_user")]),s._v(" "),n("td",[s._v("客户端用户名称")])]),s._v(" "),n("tr",[n("td",[s._v("$time_local")]),s._v(" "),n("td",[s._v("访问时间和时区")])]),s._v(" "),n("tr",[n("td",[s._v("$request")]),s._v(" "),n("td",[s._v("请求的URI和HTTP协议")])]),s._v(" "),n("tr",[n("td",[s._v("$http_host")]),s._v(" "),n("td",[s._v("请求地址，即浏览器中你输入的地址（IP或域名）")])]),s._v(" "),n("tr",[n("td",[s._v("$status")]),s._v(" "),n("td",[s._v("HTTP请求状态 200")])]),s._v(" "),n("tr",[n("td",[s._v("$upstream_status")]),s._v(" "),n("td",[s._v("upstream状态 200")])]),s._v(" "),n("tr",[n("td",[s._v("$body_bytes_sent")]),s._v(" "),n("td",[s._v("发送给客户端文件内容大小")])]),s._v(" "),n("tr",[n("td",[s._v("$http_referer")]),s._v(" "),n("td",[s._v("url跳转来源")])]),s._v(" "),n("tr",[n("td",[s._v("$http_user_agent")]),s._v(" "),n("td",[s._v("用户终端浏览器等信息 设备信息")])]),s._v(" "),n("tr",[n("td",[s._v("$ssl_protocol")]),s._v(" "),n("td",[s._v("SSL协议版本 TLSv1")])]),s._v(" "),n("tr",[n("td",[s._v("$ssl_cipher")]),s._v(" "),n("td",[s._v("交换数据中的算法 RC4-SHA")])]),s._v(" "),n("tr",[n("td",[s._v("$upstream_addr")]),s._v(" "),n("td",[s._v("后台upstream的地址，即真正提供服务的主机地址")])]),s._v(" "),n("tr",[n("td",[s._v("$request_time")]),s._v(" "),n("td",[s._v("整个请求的总时间(s)")])]),s._v(" "),n("tr",[n("td",[s._v("$upstream_response_time")]),s._v(" "),n("td",[s._v("请求过程中，upstream响应时间")])])])]),s._v(" "),n("h3",{attrs:{id:"使用ng做ab测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用ng做ab测试"}},[s._v("#")]),s._v(" 使用ng做AB测试")]),s._v(" "),n("p",[s._v("AB测即一个产品几个版本,我们会将现网一小部分用户的访问引流到新版本nginx提供了“"),n("br"),s._v("\nnginx_http_split_clients_module”、“nginx_stream_split_clients_module”分别简单实现了http和tcp的这些功能")]),s._v(" "),n("h4",{attrs:{id:"简单使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简单使用"}},[s._v("#")]),s._v(" 简单使用")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('http {\n    split_clients "${remote_addr}AAA" $variant {\n        0.5%    .one;\n        2.0%    .two;\n        *       "";\n    }\n\n    server {\n        location / {\n            index index${variant}.html;\n\t    }\n\t}\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("根据计算 0 到21474835 (0.5%) variant = .one"),n("br"),s._v("\n21474836到107374180 (2%) variant = .two"),n("br"),s._v("\n其余值为空值"),n("br"),s._v("\n(* 号 不可用 剩余百分比来替代)")]),s._v(" "),n("h4",{attrs:{id:"更好的方法-根据cookies-或者userid"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#更好的方法-根据cookies-或者userid"}},[s._v("#")]),s._v(" 更好的方法 根据cookies 或者userID")]),s._v(" "),n("p",[s._v("1、请求可以代理到任意空间"),n("br"),s._v("\n2、设置cookie，给定一个期限做测试"),n("br"),s._v("\n3、检测cookie是否能够按照正确的方式代理到指定的空间，从而确保统一的用户体验。"),n("br"),s._v("\n这里我们假设有两个版本的应用，他们的服务端口分别为8888和9999，我们使用nginx给这两个版本做A/B测试，具体的配置如下")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('http {\n    # ...\n    upstream old{\n        server server 192.168.1.100:8888; \n    }\n\n    upstream new{\n        server server 192.168.1.100:9999;\n    }\n    split_clients "app${remote_addr}${http_user_agent}${date_gmt}"    $appversion {\n        80%     old;\n        *       new;\n    }\n    map $cookie_test_version $upstream_group {\n        default $appversion;\n        "old"  "old";\n        "new" "new";\n    }\n\tserver {\n        listen 80;\n        location / {\n            add_header Set-Cookie "test_version=$upstream_group;Path=/;Max-Age=518400;";\n            proxy_set_header Host $host;\n            if ($upstream_group = "old") {\n                proxy_pass http://192.168.1.100:8888;\n                break;\n            }\n          if ($upstream_group = "new") {\n                proxy_pass http://192.168.1.100:9999;\n                break;\n            }\n          proxy_pass http://$appversion;\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("h3",{attrs:{id:"规范-方式和目的"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#规范-方式和目的"}},[s._v("#")]),s._v(" 规范, 方式和目的")]),s._v(" "),n("p",[s._v("1、日志格式统一，可以极大的简化日志收集和分析的复杂度；"),n("br"),s._v("\n2、排查问题更加便捷；"),n("br"),s._v("\n3、为了避免日志格式的变化给所有相关团队带来干扰，降低改动的影响面，日志中的字段进行分“域”；"),n("br"),s._v("\n每个域包括多个字段，不同的团队关注不同的域，某个域中的字段列表改动时，不影响其他团队对数据的使用；"),n("br"),s._v("\n4、为了便于数据分拣、日志收集，我们约定所有的日志文件名必须遵循统一规则;nginx日志、tomcat access log、业务日志等，日志的文件名遵循："),n("code",[s._v("<project-name>.<tag>.log.<yyyy-MM-dd>.<index>")]),s._v(" ；\n5、严格控制日志文件的大小，适时对日志文件进行rolling，我们约定任何日志文件的大小不得超过256M，超过此值时应该对日志进行rolling。原因非常简单，较大的日志文件既不便于收集、传输，也不便于进行查看，此外较大的日志还会降低文件IO的效率。在此基础上，我们要求在打印日志时需要对日志信息进行合理规划，尽可能精简日志信息，冗杂而庞大的日志信息不仅价值较低，而且消耗存储，此外较大的日志内容输出还会增加宿主机器的IO负载，毕竟我们的普通的application机器的IOPS通常不高；"),n("br"),s._v("\n6、为了便于日志分拣、日志内容的可读性、本地性，我们在nginx、tomcat等所有日志内容中，都打印“当前机器的IP”、“日志产生的时间戳”等标记信息。")])])}],!1,null,null,null);t.default=e.exports}}]);