<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>日志规范 | 前端开发规范</title>
    <meta name="description" content="Front-end Development Specification">
    <link rel="icon" href="/images/logo.png">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.e2ad1fe3.css" as="style"><link rel="preload" href="/assets/js/app.4cd4ccbc.js" as="script"><link rel="preload" href="/assets/js/11.230f678e.js" as="script"><link rel="prefetch" href="/assets/js/10.aa2938b5.js"><link rel="prefetch" href="/assets/js/12.8ca1eca7.js"><link rel="prefetch" href="/assets/js/13.6e005108.js"><link rel="prefetch" href="/assets/js/14.a1d46b48.js"><link rel="prefetch" href="/assets/js/2.2b61d0dc.js"><link rel="prefetch" href="/assets/js/3.f4411b3b.js"><link rel="prefetch" href="/assets/js/4.753fa98c.js"><link rel="prefetch" href="/assets/js/5.831a00aa.js"><link rel="prefetch" href="/assets/js/6.4dd4b28b.js"><link rel="prefetch" href="/assets/js/7.09a1190c.js"><link rel="prefetch" href="/assets/js/8.90854bad.js"><link rel="prefetch" href="/assets/js/9.6cf6f248.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2ad1fe3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端开发规范</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rookieHandbook/" class="nav-link">新人入职指南</a></div><div class="nav-item"><a href="/codingSpecification/" class="nav-link">编码规范</a></div><div class="nav-item"><a href="/developmentProcess/" class="nav-link">开发规范</a></div><div class="nav-item"><a href="/documentTemplate/" class="nav-link">文档模板</a></div><div class="nav-item"><a href="/warehouseCreationSpecification/" class="nav-link">仓库创建规范</a></div><div class="nav-item"><a href="/logSpecification/" aria-current="page" class="nav-link router-link-exact-active router-link-active">日志规范</a></div><div class="nav-item"><a href="/performanceSpecification/" class="nav-link">性能规范</a></div><div class="nav-item"><a href="/toolLintSpecification/" class="nav-link">工具Lint</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rookieHandbook/" class="nav-link">新人入职指南</a></div><div class="nav-item"><a href="/codingSpecification/" class="nav-link">编码规范</a></div><div class="nav-item"><a href="/developmentProcess/" class="nav-link">开发规范</a></div><div class="nav-item"><a href="/documentTemplate/" class="nav-link">文档模板</a></div><div class="nav-item"><a href="/warehouseCreationSpecification/" class="nav-link">仓库创建规范</a></div><div class="nav-item"><a href="/logSpecification/" aria-current="page" class="nav-link router-link-exact-active router-link-active">日志规范</a></div><div class="nav-item"><a href="/performanceSpecification/" class="nav-link">性能规范</a></div><div class="nav-item"><a href="/toolLintSpecification/" class="nav-link">工具Lint</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>日志规范</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/logSpecification/#ng配置" class="sidebar-link">ng配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logSpecification/#使用ng做ab测试" class="sidebar-link">使用ng做AB测试</a></li><li class="sidebar-sub-header"><a href="/logSpecification/#规范-方式和目的" class="sidebar-link">规范, 方式和目的</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="日志规范"><a href="#日志规范" class="header-anchor">#</a> 日志规范</h1> <h1 id="_1-nginx日志规范"><a href="#_1-nginx日志规范" class="header-anchor">#</a> 1.Nginx日志规范</h1> <h2 id="ng配置"><a href="#ng配置" class="header-anchor">#</a> ng配置</h2> <p>一般来说：nginx的log_format有很多可选的参数用于指示服务器的活动状态，默认的是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                  '$status $body_bytes_sent &quot;$http_referer&quot; '
                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><table><thead><tr><th>参数</th> <th>说明</th></tr></thead> <tbody><tr><td>$remote_addr</td> <td>客户端地址</td></tr> <tr><td>$remote_user</td> <td>客户端用户名称</td></tr> <tr><td>$time_local</td> <td>访问时间和时区</td></tr> <tr><td>$request</td> <td>请求的URI和HTTP协议</td></tr> <tr><td>$http_host</td> <td>请求地址，即浏览器中你输入的地址（IP或域名）</td></tr> <tr><td>$status</td> <td>HTTP请求状态 200</td></tr> <tr><td>$upstream_status</td> <td>upstream状态 200</td></tr> <tr><td>$body_bytes_sent</td> <td>发送给客户端文件内容大小</td></tr> <tr><td>$http_referer</td> <td>url跳转来源</td></tr> <tr><td>$http_user_agent</td> <td>用户终端浏览器等信息 设备信息</td></tr> <tr><td>$ssl_protocol</td> <td>SSL协议版本 TLSv1</td></tr> <tr><td>$ssl_cipher</td> <td>交换数据中的算法 RC4-SHA</td></tr> <tr><td>$upstream_addr</td> <td>后台upstream的地址，即真正提供服务的主机地址</td></tr> <tr><td>$request_time</td> <td>整个请求的总时间(s)</td></tr> <tr><td>$upstream_response_time</td> <td>请求过程中，upstream响应时间</td></tr></tbody></table> <h3 id="使用ng做ab测试"><a href="#使用ng做ab测试" class="header-anchor">#</a> 使用ng做AB测试</h3> <p>AB测即一个产品几个版本,我们会将现网一小部分用户的访问引流到新版本nginx提供了“<br>
nginx_http_split_clients_module”、“nginx_stream_split_clients_module”分别简单实现了http和tcp的这些功能</p> <h4 id="简单使用"><a href="#简单使用" class="header-anchor">#</a> 简单使用</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>http {
    split_clients &quot;${remote_addr}AAA&quot; $variant {
        0.5%    .one;
        2.0%    .two;
        *       &quot;&quot;;
    }

    server {
        location / {
            index index${variant}.html;
	    }
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>根据计算 0 到21474835 (0.5%) variant = .one<br>
21474836到107374180 (2%) variant = .two<br>
其余值为空值<br>
(* 号 不可用 剩余百分比来替代)</p> <h4 id="更好的方法-根据cookies-或者userid"><a href="#更好的方法-根据cookies-或者userid" class="header-anchor">#</a> 更好的方法 根据cookies 或者userID</h4> <p>1、请求可以代理到任意空间<br>
2、设置cookie，给定一个期限做测试<br>
3、检测cookie是否能够按照正确的方式代理到指定的空间，从而确保统一的用户体验。<br>
这里我们假设有两个版本的应用，他们的服务端口分别为8888和9999，我们使用nginx给这两个版本做A/B测试，具体的配置如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http {
    # ...
    upstream old{
        server server 192.168.1.100:8888; 
    }

    upstream new{
        server server 192.168.1.100:9999;
    }
    split_clients &quot;app${remote_addr}${http_user_agent}${date_gmt}&quot;    $appversion {
        80%     old;
        *       new;
    }
    map $cookie_test_version $upstream_group {
        default $appversion;
        &quot;old&quot;  &quot;old&quot;;
        &quot;new&quot; &quot;new&quot;;
    }
	server {
        listen 80;
        location / {
            add_header Set-Cookie &quot;test_version=$upstream_group;Path=/;Max-Age=518400;&quot;;
            proxy_set_header Host $host;
            if ($upstream_group = &quot;old&quot;) {
                proxy_pass http://192.168.1.100:8888;
                break;
            }
          if ($upstream_group = &quot;new&quot;) {
                proxy_pass http://192.168.1.100:9999;
                break;
            }
          proxy_pass http://$appversion;
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="规范-方式和目的"><a href="#规范-方式和目的" class="header-anchor">#</a> 规范, 方式和目的</h3> <p>1、日志格式统一，可以极大的简化日志收集和分析的复杂度；<br>
2、排查问题更加便捷；<br>
3、为了避免日志格式的变化给所有相关团队带来干扰，降低改动的影响面，日志中的字段进行分“域”；<br>
每个域包括多个字段，不同的团队关注不同的域，某个域中的字段列表改动时，不影响其他团队对数据的使用；<br>
4、为了便于数据分拣、日志收集，我们约定所有的日志文件名必须遵循统一规则;nginx日志、tomcat access log、业务日志等，日志的文件名遵循：<code>&lt;project-name&gt;.&lt;tag&gt;.log.&lt;yyyy-MM-dd&gt;.&lt;index&gt;</code> ；
5、严格控制日志文件的大小，适时对日志文件进行rolling，我们约定任何日志文件的大小不得超过256M，超过此值时应该对日志进行rolling。原因非常简单，较大的日志文件既不便于收集、传输，也不便于进行查看，此外较大的日志还会降低文件IO的效率。在此基础上，我们要求在打印日志时需要对日志信息进行合理规划，尽可能精简日志信息，冗杂而庞大的日志信息不仅价值较低，而且消耗存储，此外较大的日志内容输出还会增加宿主机器的IO负载，毕竟我们的普通的application机器的IOPS通常不高；<br>
6、为了便于日志分拣、日志内容的可读性、本地性，我们在nginx、tomcat等所有日志内容中，都打印“当前机器的IP”、“日志产生的时间戳”等标记信息。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.4cd4ccbc.js" defer></script><script src="/assets/js/11.230f678e.js" defer></script>
  </body>
</html>
